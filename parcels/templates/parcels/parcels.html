{% extends 'vertical_base.html' %}

{% load static %}

{% block title %}Leaflet{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
                <div class="float-end">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Agro Tech</a></li>
                        <li class="breadcrumb-item"><a href="#">Mapas</a></li>
                        <li class="breadcrumb-item active">Seleccionar campo</li>
                    </ol>
                </div>
                <h4 class="page-title">Selecciona tu campo</h4>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Mapa Predeterminado</h4>
                </div>
                <div class="card-body">
                    <div id="map_default" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        <--<div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Mapa con Límites</h4>
                </div>
                <div class="card-body">
                    <div id="map_bounds" style="height: 400px;"></div>
                </div>
            </div>-->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_javascript %}

<div id="map" style="height: 500px;"></div>

<script>
// Obtén el subdominio actual para el tenant
const tenantDomain = window.location.hostname;  // Esto obtiene el subdominio actual (ej. "proarroz.localhost")

// Asegúrate de que la URL tenga el subdominio correcto
const apiUrl = `http://${tenantDomain}:8000/parcels/`;  // Cambia esta URL si es necesario

const map = L.map('map').setView([4.570868, -74.297333], 5); // Coordenadas de Colombia
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Obtener el token JWT almacenado en localStorage
const token = localStorage.getItem('token');
console.log('Token JWT:', token);  // Verificar si el token se está obteniendo correctamente

if (!token) {
    console.error('Token no encontrado en localStorage');
    return;
}

// Realizar la solicitud a la API con el token
fetch(apiUrl, {
    method: 'GET',
    headers: {
        'Authorization': 'Bearer ' + token  // Añadir el token JWT aquí
    }
})
.then(response => {
    if (!response.ok) {
        throw new Error('No autorizado o error en la solicitud');
    }
    return response.json();
})
.then(data => {
    // Añadir parcelas al mapa si los datos existen
    if (data && data.features && data.features.length > 0) {
        L.geoJSON(data).addTo(map);
    } else {
        console.log('No hay parcelas disponibles');
    }
})
.catch(error => {
    console.error('Error al obtener los datos de parcelas:', error);
});

// Agregar evento para crear parcelas
let drawnPolygon;
map.on('click', (e) => {
    if (drawnPolygon) map.removeLayer(drawnPolygon);
    drawnPolygon = L.polygon([[e.latlng.lat, e.latlng.lng], ...]).addTo(map);
});



{% endblock %}
