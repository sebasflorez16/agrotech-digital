<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - An√°lisis Meteorol√≥gico</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>üå± Test An√°lisis Meteorol√≥gico</h2>
                <button onclick="setTokenAndTest()" class="btn btn-primary mb-3">Configurar Token y Probar</button>
                <button onclick="testMeteorologicalAnalysis()" class="btn btn-success mb-3">Probar An√°lisis</button>
                
                <div id="results" class="mt-3"></div>
                
                <!-- Contenedor del gr√°fico -->
                <div id="chartContainer" style="display:none;" class="mt-4">
                    <canvas id="testChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurar el token
        function setTokenAndTest() {
            const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU1OTczMzIzLCJpYXQiOjE3NTU5NjM3MjMsImp0aSI6ImVhZGU1YzkwZjhkMjQ5ZjliZDY2MjRlMWRiZjljOWJjIiwidXNlcl9pZCI6MX0.0mrAwiEVtBDMzTQEuUfpBZp1HmLtIgvPqWuFikMapeQ';
            localStorage.setItem('accessToken', token);
            
            document.getElementById('results').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Token configurado correctamente en localStorage<br>
                    <small>Token: ${token.substring(0, 50)}...</small>
                </div>
            `;
        }

        // Funci√≥n similar a getAuthToken del archivo original
        function getAuthToken() {
            return localStorage.getItem('accessToken') || 
                   localStorage.getItem('authToken') || 
                   sessionStorage.getItem('accessToken') ||
                   sessionStorage.getItem('authToken') || '';
        }

        // Test del an√°lisis meteorol√≥gico
        async function testMeteorologicalAnalysis() {
            const resultsDiv = document.getElementById('results');
            
            try {
                resultsDiv.innerHTML = '<div class="alert alert-info">üîÑ Cargando datos...</div>';
                
                const token = getAuthToken();
                if (!token) {
                    throw new Error('No se encontr√≥ token de autenticaci√≥n');
                }
                
                const endpoint = 'http://prueba.localhost:8000/api/parcels/parcel/6/ndvi-weather-comparison/';
                
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Mostrar resultados
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ Datos recibidos correctamente</h5>
                        <p><strong>Parcela:</strong> ${data.parcel_info?.name || 'N/A'}</p>
                        <p><strong>Datos sincronizados:</strong> ${data.synchronized_data?.length || 0}</p>
                        <p><strong>Correlaciones:</strong> ${Object.keys(data.correlations || {}).length}</p>
                        <p><strong>Insights:</strong> ${data.insights?.length || 0}</p>
                    </div>
                `;
                
                // Renderizar gr√°fico si hay datos
                if (data.synchronized_data && data.synchronized_data.length > 0) {
                    renderTestChart(data.synchronized_data);
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Error</h5>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('Error:', error);
            }
        }

        // Renderizar gr√°fico de prueba
        function renderTestChart(data) {
            const chartContainer = document.getElementById('chartContainer');
            const ctx = document.getElementById('testChart');
            
            chartContainer.style.display = 'block';
            
            const dates = data.map(d => d.date);
            const ndviData = data.map(d => d.ndvi?.mean || 0);
            const tempData = data.map(d => d.weather?.temperature || 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'NDVI',
                            data: ndviData,
                            borderColor: '#2E7D32',
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Temperatura (¬∞C)',
                            data: tempData,
                            borderColor: '#E65100',
                            backgroundColor: 'rgba(230, 81, 0, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'NDVI'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Temperatura (¬∞C)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
