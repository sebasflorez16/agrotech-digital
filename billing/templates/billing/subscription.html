{% extends 'billing/base_billing.html' %}
{% load static %}

{% block title %}Mi Suscripción - AgroTech Digital{% endblock %}
{% block nav_sub_active %}active{% endblock %}

{% block extra_css %}
<style>
/* ══════ SUBSCRIPTION — Apple Dark Style ══════ */
.sub-header {
    padding: 80px 0 40px;
}

.sub-header h1 {
    font-size: clamp(28px, 4vw, 40px);
    font-weight: 800;
    letter-spacing: -0.03em;
    color: var(--texto-claro);
    margin-bottom: 8px;
}

.sub-header .subtitle {
    font-size: 16px;
    color: var(--gris-400);
}

/* Status card */
.status-hero {
    background: var(--gris-950);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: var(--radius-xl);
    padding: 36px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    margin-bottom: 24px;
}

.status-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.plan-icon-lg {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(52, 199, 89, 0.15), rgba(52, 199, 89, 0.05));
    border-radius: 18px;
    font-size: 28px;
    color: var(--verde-claro);
}

.plan-meta h2 {
    font-size: 22px;
    font-weight: 800;
    color: var(--texto-claro);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.badge-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 14px;
    border-radius: 980px;
    font-size: 12px;
    font-weight: 700;
}

.badge-active {
    background: rgba(52, 199, 89, 0.15);
    color: var(--verde-claro);
}

.badge-active::before {
    content: '';
    width: 6px;
    height: 6px;
    background: var(--verde-claro);
    border-radius: 50%;
}

.badge-inactive {
    background: rgba(255, 159, 10, 0.15);
    color: var(--naranja);
}

.badge-cancelled {
    background: rgba(255, 69, 58, 0.15);
    color: #FF453A;
}

.plan-meta p {
    font-size: 14px;
    color: var(--gris-400);
    margin: 0;
}

.status-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: 980px;
    font-size: 13px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: var(--transition-smooth);
    border: none;
    text-decoration: none;
}

.btn-sm-green {
    background: var(--verde-claro);
    color: #000;
}

.btn-sm-green:hover {
    background: var(--verde-accent);
    box-shadow: 0 6px 16px rgba(52, 199, 89, 0.3);
    color: #000;
}

.btn-sm-outline {
    background: transparent;
    color: var(--gris-200);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-sm-outline:hover {
    background: rgba(255, 255, 255, 0.04);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--texto-claro);
}

.btn-sm-danger {
    background: rgba(255, 69, 58, 0.1);
    color: #FF453A;
    border: 1px solid rgba(255, 69, 58, 0.15);
}

.btn-sm-danger:hover {
    background: rgba(255, 69, 58, 0.2);
}

/* ══════ STATS GRID ══════ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--gris-950);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 16px;
    padding: 24px;
}

.stat-card .stat-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gris-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.stat-card .stat-label i {
    color: var(--verde-claro);
    font-size: 16px;
}

.stat-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--texto-claro);
    margin-bottom: 4px;
}

.stat-sub {
    font-size: 12px;
    color: var(--gris-400);
}

.progress-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.06);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--verde-claro);
    transition: width 0.6s ease;
}

.progress-fill.warning {
    background: var(--naranja);
}

.progress-fill.danger {
    background: #FF453A;
}

/* ══════ TWO-COL LAYOUT ══════ */
.sub-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.card {
    background: var(--gris-950);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: var(--radius-lg);
    padding: 28px;
}

.card h3 {
    font-size: 16px;
    font-weight: 700;
    color: var(--texto-claro);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card h3 i {
    color: var(--verde-claro);
    font-size: 18px;
}

/* Plan detail rows */
.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    font-size: 14px;
}

.info-row:last-child { border-bottom: none; }

.info-label {
    color: var(--gris-400);
}

.info-value {
    color: var(--texto-claro);
    font-weight: 600;
}

/* Invoice table */
.invoice-table {
    width: 100%;
    border-collapse: collapse;
}

.invoice-table th {
    text-align: left;
    padding: 10px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gris-400);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.invoice-table td {
    padding: 14px 12px;
    font-size: 14px;
    color: var(--gris-200);
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}

.invoice-status {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 980px;
    font-size: 11px;
    font-weight: 600;
}

.invoice-paid {
    background: rgba(52, 199, 89, 0.15);
    color: var(--verde-claro);
}

.invoice-pending {
    background: rgba(255, 159, 10, 0.15);
    color: var(--naranja);
}

/* Renewal alert */
.renewal-alert {
    background: linear-gradient(165deg, rgba(52, 199, 89, 0.06) 0%, var(--gris-950) 60%);
    border: 1px solid rgba(52, 199, 89, 0.12);
    border-radius: 16px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 24px;
}

.renewal-alert i {
    color: var(--verde-claro);
    font-size: 20px;
}

.renewal-alert p {
    font-size: 14px;
    color: var(--gris-200);
    margin: 0;
    flex: 1;
}

.renewal-alert strong {
    color: var(--texto-claro);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 80px 20px;
}

.empty-icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 50%;
    font-size: 36px;
    color: var(--gris-600);
}

.empty-state h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--texto-claro);
    margin-bottom: 8px;
}

.empty-state p {
    font-size: 15px;
    color: var(--gris-400);
    margin-bottom: 32px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.btn-explore {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 32px;
    background: var(--verde-claro);
    color: #000;
    border: none;
    border-radius: 980px;
    font-size: 15px;
    font-weight: 700;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: var(--transition-smooth);
    text-decoration: none;
}

.btn-explore:hover {
    background: var(--verde-accent);
    box-shadow: 0 8px 24px rgba(52, 199, 89, 0.3);
    transform: scale(1.02);
    color: #000;
}

/* Loading */
.loading-placeholder {
    text-align: center;
    padding: 60px;
}

.mini-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255, 255, 255, 0.08);
    border-top-color: var(--verde-claro);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 12px;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 900px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .sub-grid { grid-template-columns: 1fr; }
    .status-hero { flex-direction: column; text-align: center; }
    .status-left { flex-direction: column; }
    .status-actions { justify-content: center; }
}

@media (max-width: 540px) {
    .stats-grid { grid-template-columns: 1fr; }
    .sub-header { padding: 48px 0 24px; }
    .sub-header h1 { font-size: 24px; }
    .sub-header .subtitle { font-size: 14px; }
    .status-hero { padding: 24px; border-radius: 16px; }
    .plan-icon-lg { width: 48px; height: 48px; font-size: 22px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="sub-header">
        <h1>Mi Suscripción</h1>
        <p class="subtitle">Gestiona tu plan, uso y facturación.</p>
    </div>

    <!-- Loading -->
    <div id="loadingState" class="loading-placeholder">
        <div class="mini-spinner"></div>
        <p style="color: var(--gris-400); font-size: 14px;">Cargando información...</p>
    </div>

    <!-- Empty state (hidden by default) -->
    <div id="emptyState" style="display:none;">
        <div class="empty-state">
            <div class="empty-icon"><i class="ti ti-credit-card-off"></i></div>
            <h2>No tienes suscripción activa</h2>
            <p>Elige un plan para empezar a usar todas las herramientas de AgroTech Digital.</p>
            <a href="/billing/planes/" class="btn-explore">
                <i class="ti ti-rocket"></i> Explorar Planes
            </a>
        </div>
    </div>

    <!-- Active subscription (hidden by default) -->
    <div id="activeState" style="display:none;">
        <!-- Status Hero -->
        <div class="status-hero">
            <div class="status-left">
                <div class="plan-icon-lg"><i class="ti ti-tractor" id="planIconEl"></i></div>
                <div class="plan-meta">
                    <h2>
                        <span id="planNameEl">—</span>
                        <span class="badge-status badge-active" id="statusBadge">Activo</span>
                    </h2>
                    <p id="planCycleEl">—</p>
                </div>
            </div>
            <div class="status-actions">
                <a href="/billing/planes/" class="btn-sm btn-sm-green"><i class="ti ti-arrow-up"></i> Mejorar Plan</a>
                <button class="btn-sm btn-sm-danger" id="btnCancel"><i class="ti ti-x"></i> Cancelar</button>
            </div>
        </div>

        <!-- Renewal Alert -->
        <div class="renewal-alert" id="renewalAlert" style="display:none;">
            <i class="ti ti-calendar-event"></i>
            <p>Tu próxima facturación es el <strong id="nextBillingDate">—</strong></p>
        </div>

        <!-- Usage Stats -->
        <div class="stats-grid" id="statsGrid">
            <!-- Filled by JS -->
        </div>

        <!-- Two Column: Plan Details + Invoices -->
        <div class="sub-grid">
            <div class="card">
                <h3><i class="ti ti-file-description"></i> Detalles del Plan</h3>
                <div id="planDetails">
                    <!-- Filled by JS -->
                </div>
            </div>
            <div class="card">
                <h3><i class="ti ti-receipt-2"></i> Historial de Pagos</h3>
                <div id="invoiceSection">
                    <p style="color: var(--gris-400); font-size: 14px; text-align: center; padding: 20px 0;">Sin pagos registrados.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingEl = document.getElementById('loadingState');
    const emptyEl = document.getElementById('emptyState');
    const activeEl = document.getElementById('activeState');

    async function loadSubscription() {
        try {
            const res = await fetch('/billing/api/my-subscription/', {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });

            if (res.status === 404 || res.status === 401) {
                showEmpty();
                return;
            }

            const data = await res.json();

            if (!data || !data.plan_tier || data.plan_tier === 'free') {
                showEmpty();
                return;
            }

            showActive(data);
        } catch (e) {
            console.error('Error cargando suscripción:', e);
            showEmpty();
        }
    }

    function showEmpty() {
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
    }

    function showActive(sub) {
        loadingEl.style.display = 'none';
        activeEl.style.display = 'block';

        const planNames = { 'basic': 'Agricultor', 'pro': 'Empresarial', 'free': 'Explorador' };
        const planIcons = { 'basic': 'ti-tractor', 'pro': 'ti-building', 'free': 'ti-leaf' };

        // Header
        document.getElementById('planNameEl').textContent = planNames[sub.plan_tier] || sub.plan_name || sub.plan_tier;
        document.getElementById('planIconEl').className = 'ti ' + (planIcons[sub.plan_tier] || 'ti-tractor');
        document.getElementById('planCycleEl').textContent =
            (sub.billing_cycle === 'yearly' ? 'Facturación Anual' : 'Facturación Mensual') +
            (sub.price_cop ? ' • $' + fmtCOP(sub.price_cop) : '');

        // Status badge
        const badge = document.getElementById('statusBadge');
        const statusMap = { 'active': ['Activo', 'badge-active'], 'authorized': ['Activo', 'badge-active'], 'pending': ['Pendiente', 'badge-inactive'], 'cancelled': ['Cancelado', 'badge-cancelled'] };
        const [text, cls] = statusMap[sub.status] || ['Activo', 'badge-active'];
        badge.textContent = text;
        badge.className = 'badge-status ' + cls;

        // Renewal
        if (sub.next_billing_date) {
            document.getElementById('renewalAlert').style.display = 'flex';
            document.getElementById('nextBillingDate').textContent = formatDate(sub.next_billing_date);
        }

        // Stats
        renderStats(sub);

        // Plan Details
        renderDetails(sub);

        // Invoices
        if (sub.invoices && sub.invoices.length) renderInvoices(sub.invoices);

        // Cancel button
        document.getElementById('btnCancel').addEventListener('click', async () => {
            if (!confirm('¿Estás seguro de que deseas cancelar tu suscripción?')) return;
            try {
                const r = await fetch('/billing/api/cancel-subscription/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
                });
                const d = await r.json();
                if (d.success || r.ok) {
                    alert('Suscripción cancelada exitosamente.');
                    location.reload();
                } else {
                    alert('Error: ' + (d.error || 'No se pudo cancelar.'));
                }
            } catch(e) { alert('Error cancelando suscripción.'); }
        });
    }

    function renderStats(sub) {
        const limits = sub.limits || {};
        const usage = sub.usage || {};
        const stats = [
            { label: 'Hectáreas', icon: 'ti-map-pin', used: usage.hectares || 0, total: limits.hectares || 50, unit: 'ha' },
            { label: 'Análisis', icon: 'ti-satellite', used: usage.eosda_requests || 0, total: limits.eosda_requests || 10, unit: '' },
            { label: 'Usuarios', icon: 'ti-users', used: usage.users || 1, total: limits.users || 1, unit: '' },
            { label: 'Parcelas', icon: 'ti-layout-grid', used: usage.parcels || 0, total: limits.parcels || 3, unit: '' },
        ];

        document.getElementById('statsGrid').innerHTML = stats.map(s => {
            const pct = s.total > 0 ? Math.min((s.used / s.total) * 100, 100) : 0;
            const barClass = pct > 90 ? 'danger' : pct > 70 ? 'warning' : '';
            return `
            <div class="stat-card">
                <div class="stat-label"><i class="ti ${s.icon}"></i> ${s.label}</div>
                <div class="stat-value">${s.used}<span style="font-size:14px;color:var(--gris-400);font-weight:400;">/${s.total}${s.unit ? ' ' + s.unit : ''}</span></div>
                <div class="progress-bar"><div class="progress-fill ${barClass}" style="width:${pct}%"></div></div>
            </div>`;
        }).join('');
    }

    function renderDetails(sub) {
        const rows = [
            ['Plan', sub.plan_name || sub.plan_tier],
            ['Ciclo', sub.billing_cycle === 'yearly' ? 'Anual' : 'Mensual'],
            ['Precio', sub.price_cop ? '$' + fmtCOP(sub.price_cop) : '—'],
            ['Inicio', sub.start_date ? formatDate(sub.start_date) : '—'],
            ['Próxima factura', sub.next_billing_date ? formatDate(sub.next_billing_date) : '—'],
            ['ID Suscripción', sub.mp_preapproval_id || sub.subscription_id || '—'],
        ];
        document.getElementById('planDetails').innerHTML = rows.map(([l, v]) =>
            `<div class="info-row"><span class="info-label">${l}</span><span class="info-value">${v}</span></div>`
        ).join('');
    }

    function renderInvoices(invoices) {
        document.getElementById('invoiceSection').innerHTML = `
        <table class="invoice-table">
            <thead><tr><th>Fecha</th><th>Monto</th><th>Estado</th></tr></thead>
            <tbody>
                ${invoices.map(inv => `
                <tr>
                    <td>${formatDate(inv.date)}</td>
                    <td>$${fmtCOP(inv.amount)}</td>
                    <td><span class="invoice-status ${inv.status === 'paid' ? 'invoice-paid' : 'invoice-pending'}">${inv.status === 'paid' ? 'Pagado' : 'Pendiente'}</span></td>
                </tr>`).join('')}
            </tbody>
        </table>`;
    }

    function fmtCOP(n) { return new Intl.NumberFormat('es-CO').format(n); }
    function formatDate(d) {
        try { return new Date(d).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' }); }
        catch(e) { return d; }
    }

    function getCookie(name) {
        let v = null;
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) v = decodeURIComponent(c.substring(name.length + 1));
        });
        return v;
    }

    loadSubscription();
});
</script>
{% endblock %}
