{% extends 'billing/base_billing.html' %}
{% load static %}

{% block title %}Planes y Precios - AgroTech Digital{% endblock %}
{% block nav_planes_active %}active{% endblock %}

{% block extra_css %}
<style>
/* ══════ PRICING — Apple Dark Style ══════ */
.pricing-hero {
    text-align: center;
    padding: 80px 0 40px;
}

.section-title {
    font-size: clamp(32px, 5vw, 56px);
    font-weight: 800;
    letter-spacing: -0.03em;
    line-height: 1.1;
    margin-bottom: 8px;
    color: var(--texto-claro);
}

.section-subtitle {
    text-align: center;
    font-size: 19px;
    color: var(--gris-400);
    margin-bottom: 0;
    margin-top: 4px;
}

/* Toggle */
.billing-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin: 40px 0 48px;
}

.billing-toggle span {
    font-size: 15px;
    font-weight: 500;
    color: var(--gris-600);
    transition: var(--transition-smooth);
    cursor: pointer;
}

.billing-toggle span.active {
    color: var(--texto-claro);
    font-weight: 600;
}

.toggle-switch {
    position: relative;
    width: 56px;
    height: 28px;
    background: var(--gris-800);
    border-radius: 14px;
    cursor: pointer;
    transition: var(--transition-smooth);
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.toggle-switch.active {
    background: var(--verde-principal);
    border-color: var(--verde-claro);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: #fff;
    border-radius: 50%;
    transition: var(--transition-smooth);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.toggle-switch.active::after {
    left: 31px;
}

.save-badge {
    background: var(--naranja);
    color: #000;
    padding: 4px 12px;
    border-radius: 980px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.02em;
}

/* ══════ PRICING GRID ══════ */
.pricing-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.pricing-card {
    background: var(--gris-950);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: var(--radius-xl);
    padding: 48px 36px;
    position: relative;
    transition: var(--transition-smooth);
}

.pricing-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.12);
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
}

.pricing-card.featured {
    background: linear-gradient(165deg, rgba(52, 199, 89, 0.08) 0%, var(--gris-950) 60%);
    border: 1px solid rgba(52, 199, 89, 0.25);
}

.pricing-card.featured:hover {
    border-color: rgba(52, 199, 89, 0.4);
    box-shadow: 0 24px 80px rgba(52, 199, 89, 0.1);
}

.badge {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--verde-claro);
    color: #000;
    padding: 6px 14px;
    border-radius: 980px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.05em;
}

.pricing-card h3 {
    font-size: 24px;
    margin-bottom: 24px;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--texto-claro);
}

.price {
    display: flex;
    align-items: baseline;
    margin: 28px 0 36px;
}

.currency {
    font-size: 22px;
    font-weight: 600;
    color: var(--verde-claro);
    margin-right: 2px;
}

.amount {
    font-size: 56px;
    font-weight: 800;
    line-height: 1;
    letter-spacing: -0.03em;
    color: var(--texto-claro);
}

.period {
    font-size: 15px;
    color: var(--gris-400);
    margin-left: 4px;
    font-weight: 400;
}

.price-savings {
    display: block;
    font-size: 13px;
    color: var(--verde-claro);
    margin-top: 8px;
    font-weight: 500;
}

.features-list {
    list-style: none;
    margin-bottom: 32px;
}

.features-list li {
    padding: 10px 0;
    font-size: 14px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--gris-200);
}

.features-list li:last-child {
    border-bottom: none;
}

.check {
    color: var(--verde-claro);
    font-weight: 600;
    font-size: 15px;
}

.cross {
    color: rgba(255, 255, 255, 0.2);
    font-size: 15px;
}

.limit-tag {
    margin-left: auto;
    background: rgba(255, 255, 255, 0.06);
    padding: 2px 10px;
    border-radius: 980px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gris-400);
}

.btn-plan {
    display: block;
    width: 100%;
    padding: 14px;
    background: rgba(255, 255, 255, 0.06);
    color: #fff;
    text-align: center;
    border-radius: 980px;
    font-size: 15px;
    font-weight: 600;
    transition: var(--transition-smooth);
    border: 1px solid rgba(255, 255, 255, 0.08);
    cursor: pointer;
}

.btn-plan:hover {
    background: var(--verde-claro);
    color: #000;
    border-color: var(--verde-claro);
    transform: scale(1.01);
}

.pricing-card.featured .btn-plan {
    background: var(--verde-claro);
    color: #000;
    border-color: var(--verde-claro);
}

.pricing-card.featured .btn-plan:hover {
    background: var(--verde-accent);
    box-shadow: 0 8px 24px rgba(52, 199, 89, 0.3);
}

.btn-plan:disabled, .btn-plan.disabled {
    background: rgba(255, 255, 255, 0.03);
    color: var(--gris-600);
    border-color: rgba(255, 255, 255, 0.04);
    cursor: not-allowed;
    transform: none;
}

/* ══════ COMPARISON TABLE ══════ */
.comparison-section {
    margin-top: 100px;
    padding-top: 60px;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.comparison-section h3 {
    text-align: center;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 40px;
    letter-spacing: -0.02em;
    color: var(--texto-claro);
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    font-size: 14px;
}

.comparison-table th {
    background: var(--gris-950);
    font-weight: 600;
    color: var(--texto-claro);
    font-size: 15px;
}

.comparison-table td:first-child {
    text-align: left;
    font-weight: 500;
    color: var(--gris-200);
}

.comparison-table td {
    color: var(--gris-400);
}

.table-check { color: var(--verde-claro); font-size: 18px; }
.table-cross { color: rgba(255, 255, 255, 0.15); font-size: 18px; }

/* ══════ FAQ ══════ */
.faq-section {
    margin-top: 80px;
}

.faq-section h3 {
    text-align: center;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 40px;
    color: var(--texto-claro);
}

.faq-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.faq-card {
    background: var(--gris-950);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 16px;
    padding: 24px;
    transition: var(--transition-smooth);
}

.faq-card:hover {
    border-color: rgba(255, 255, 255, 0.12);
}

.faq-card h5 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--texto-claro);
}

.faq-card p {
    font-size: 14px;
    color: var(--gris-400);
    line-height: 1.6;
    margin: 0;
}

/* ══════ RESPONSIVE ══════ */
@media (max-width: 1024px) {
    .pricing-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
    .pricing-grid { grid-template-columns: 1fr; gap: 16px; max-width: 420px; }
    .pricing-card { padding: 32px 24px; }
    .faq-grid { grid-template-columns: 1fr; }
    .amount { font-size: 40px; }
    .pricing-hero { padding: 48px 0 16px; }
    .section-title { font-size: 28px; }
    .section-subtitle { font-size: 15px; }
    .comparison-section { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .comparison-table th,
    .comparison-table td { padding: 12px 10px; font-size: 12px; white-space: nowrap; }
    .billing-toggle { margin: 24px 0 32px; gap: 12px; }
    .faq-card { padding: 20px; }
    .faq-card h5 { font-size: 14px; }
    .faq-card p { font-size: 13px; }
    .comparison-section h3 { font-size: 22px; margin-bottom: 24px; }
    .faq-section h3 { font-size: 22px; }
}

@media (max-width: 480px) {
    .pricing-card { padding: 28px 20px; }
    .amount { font-size: 36px; }
    .currency { font-size: 18px; }
    .period { font-size: 13px; }
    .features-list li { font-size: 13px; padding: 8px 0; }
    .limit-tag { font-size: 11px; padding: 2px 8px; }
    .btn-plan { padding: 12px; font-size: 14px; }
    .save-badge { font-size: 11px; padding: 3px 10px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Hero -->
    <div class="pricing-hero">
        <h1 class="section-title">Planes para cada necesidad</h1>
        <p class="section-subtitle">Selecciona el plan perfecto para tu operación agrícola</p>
    </div>

    <!-- Toggle -->
    <div class="billing-toggle">
        <span class="toggle-monthly active" onclick="setBilling(false)">Mensual</span>
        <div class="toggle-switch" id="billingToggle"></div>
        <span class="toggle-yearly" onclick="setBilling(true)">Anual</span>
        <span class="save-badge">Ahorra 20%</span>
    </div>

    <!-- Pricing Cards -->
    <div class="pricing-grid" id="pricingCards">
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 0;">
            <div style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--verde-claro); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
            <p style="color: var(--gris-400);">Cargando planes...</p>
        </div>
    </div>

    <!-- Comparison Table -->
    <div class="comparison-section">
        <h3>Comparación de Características</h3>
        <div style="overflow-x: auto;">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th style="text-align:left;">Característica</th>
                        <th>Explorador</th>
                        <th>Agricultor</th>
                        <th>Empresarial</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class="ti ti-map-pin" style="color:var(--verde-claro);margin-right:8px;"></i> Hectáreas</td>
                        <td>50 ha</td>
                        <td>300 ha</td>
                        <td>1,000 ha</td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-satellite" style="color:var(--verde-claro);margin-right:8px;"></i> Análisis Satelitales/mes</td>
                        <td>10</td>
                        <td>100</td>
                        <td>500</td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-users" style="color:var(--verde-claro);margin-right:8px;"></i> Usuarios</td>
                        <td>1</td>
                        <td>3</td>
                        <td>10</td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-layout-grid" style="color:var(--verde-claro);margin-right:8px;"></i> Parcelas</td>
                        <td>3</td>
                        <td>10</td>
                        <td>50</td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-chart-line" style="color:var(--verde-claro);margin-right:8px;"></i> Análisis NDVI</td>
                        <td><span class="table-check">✓</span></td>
                        <td><span class="table-check">✓</span></td>
                        <td><span class="table-check">✓</span></td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-droplet" style="color:var(--verde-claro);margin-right:8px;"></i> Estrés Hídrico</td>
                        <td><span class="table-cross">✗</span></td>
                        <td><span class="table-check">✓</span></td>
                        <td><span class="table-check">✓</span></td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-cloud-rain" style="color:var(--verde-claro);margin-right:8px;"></i> Pronóstico Climático</td>
                        <td><span class="table-cross">✗</span></td>
                        <td><span class="table-check">✓</span></td>
                        <td><span class="table-check">✓</span></td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-code" style="color:var(--verde-claro);margin-right:8px;"></i> Acceso API</td>
                        <td><span class="table-cross">✗</span></td>
                        <td><span class="table-cross">✗</span></td>
                        <td><span class="table-check">✓</span></td>
                    </tr>
                    <tr>
                        <td><i class="ti ti-headset" style="color:var(--verde-claro);margin-right:8px;"></i> Soporte Prioritario</td>
                        <td><span class="table-cross">✗</span></td>
                        <td><span class="table-check">✓</span></td>
                        <td><span class="table-check">✓</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FAQ -->
    <div class="faq-section">
        <h3>Preguntas Frecuentes</h3>
        <div class="faq-grid">
            <div class="faq-card">
                <h5><i class="ti ti-credit-card" style="color:var(--verde-claro);margin-right:6px;"></i> ¿Qué métodos de pago aceptan?</h5>
                <p>Aceptamos tarjetas de crédito/débito, PSE y otros métodos locales a través de MercadoPago para Colombia.</p>
            </div>
            <div class="faq-card">
                <h5><i class="ti ti-refresh" style="color:var(--verde-claro);margin-right:6px;"></i> ¿Puedo cambiar de plan?</h5>
                <p>Sí, puedes mejorar tu plan en cualquier momento. El cambio se aplica inmediatamente.</p>
            </div>
            <div class="faq-card">
                <h5><i class="ti ti-arrow-back-up" style="color:var(--verde-claro);margin-right:6px;"></i> ¿Puedo cancelar en cualquier momento?</h5>
                <p>Sí, puedes cancelar tu suscripción cuando quieras. No hay contratos ni compromisos.</p>
            </div>
            <div class="faq-card">
                <h5><i class="ti ti-gift" style="color:var(--verde-claro);margin-right:6px;"></i> ¿Hay período de prueba?</h5>
                <p>Todos los planes pagos incluyen 14 días de prueba gratis. Cancela antes si no estás satisfecho.</p>
            </div>
        </div>
    </div>
</div>

@keyframes spin { to { transform: rotate(360deg); } }
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('billingToggle');
    const monthlyLabel = document.querySelector('.toggle-monthly');
    const yearlyLabel = document.querySelector('.toggle-yearly');
    const grid = document.getElementById('pricingCards');
    let isYearly = false;
    let plans = [];

    toggle.addEventListener('click', () => setBilling(!isYearly));

    window.setBilling = function(yearly) {
        isYearly = yearly;
        toggle.classList.toggle('active', isYearly);
        monthlyLabel.classList.toggle('active', !isYearly);
        yearlyLabel.classList.toggle('active', isYearly);
        render();
    };

    async function fetchPlans() {
        try {
            const res = await fetch('/billing/api/plans/');
            plans = await res.json();
            render();
        } catch (e) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px 0;"><p style="color:var(--gris-400);">Error cargando planes. Recarga la página.</p></div>';
        }
    }

    function render() {
        const icons = { 'free': 'ti-leaf', 'basic': 'ti-tractor', 'pro': 'ti-building' };
        grid.innerHTML = plans.map((p, i) => {
            const featured = p.tier === 'basic';
            const price = isYearly ? p.yearly_discount.yearly_price_cop : parseFloat(p.price_cop);
            const fmt = n => new Intl.NumberFormat('es-CO').format(n);
            const period = isYearly ? '/año' : '/mes';
            const savings = isYearly && p.yearly_discount.savings_cop > 0
                ? `<span class="price-savings">Ahorras $${fmt(p.yearly_discount.savings_cop)}</span>` : '';

            const featureMap = {
                'basic_analytics': 'Análisis básico (NDVI)',
                'advanced_analytics': 'Análisis avanzado',
                'weather_forecast': 'Pronóstico climático',
                'api_access': 'Acceso a API'
            };

            const included = [
                `<li><span class="check">✓</span> Hasta ${p.limits.hectares} hectáreas <span class="limit-tag">${p.limits.hectares} ha</span></li>`,
                `<li><span class="check">✓</span> ${p.limits.eosda_requests} análisis/mes <span class="limit-tag">${p.limits.eosda_requests}</span></li>`,
                `<li><span class="check">✓</span> ${p.limits.users} usuario${p.limits.users > 1 ? 's' : ''}</li>`,
                `<li><span class="check">✓</span> ${p.limits.parcels} parcela${p.limits.parcels > 1 ? 's' : ''}</li>`,
                ...p.features_included.map(f => `<li><span class="check">✓</span> ${featureMap[f] || f}</li>`),
                ...p.features_excluded.map(f => `<li><span class="cross">✗</span> <span style="color:var(--gris-600)">${featureMap[f] || f}</span></li>`)
            ].join('');

            return `
            <div class="pricing-card ${featured ? 'featured' : ''}">
                ${featured ? '<div class="badge">POPULAR</div>' : ''}
                <h3>${p.name}</h3>
                <div class="price">
                    ${p.tier === 'free' ? '<span class="amount">Gratis</span>' : `
                        <span class="currency">$</span>
                        <span class="amount">${fmt(price)}</span>
                        <span class="period">${period}</span>
                    `}
                </div>
                ${savings}
                <ul class="features-list">${included}</ul>
                ${p.tier === 'free'
                    ? '<button class="btn-plan disabled" disabled>Plan Actual</button>'
                    : `<button class="btn-plan" onclick="selectPlan('${p.tier}')">Comenzar Ahora</button>`
                }
            </div>`;
        }).join('');
    }

    window.selectPlan = function(tier) {
        const cycle = isYearly ? 'yearly' : 'monthly';
        window.location.href = '/billing/checkout/' + tier + '/?cycle=' + cycle;
    };

    fetchPlans();
});
</script>
{% endblock %}
